
<link rel="import" href="../../components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../components/paper-button/paper-button.html">
<link rel="import" href="../../components/iron-icons/iron-icons.html">
<link rel="import" href="../../components/iron-icons/maps-icons.html">
<link rel="import" href="../../components/paper-material/paper-material.html">
<link rel="import" href="../../components/paper-input/paper-input.html">
<link rel="import" href="../../components/paper-radio-button/paper-radio-button.html">
<link rel="import" href="../../components/paper-radio-group/paper-radio-group.html">


<dom-module id="ts-questionnaire">

    <style>
    
        :host {
            display: flex;
            flex-direction: column;
            box-sizing: border-box;
            margin-top: 60px;  /* 60px is the green header */
            height: calc(100% - 60px);
            background-color: var(--card-background-color);
            --paper-radio-button-unchecked-color: #444;
        }

        .questions {
            flex: 1 1 auto;
            padding: 0 4rem;
            overflow-y: auto;
        }

        .actions {
            flex: 0 0 62px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-top: 1px solid var(--border-color);
        }

        paper-button {
            display: flex;
            align-items: center;
            min-width: 0;
        }

        #questionnaire {
            display: flex;
        }

        paper-input {
            margin-top: 1.5rem;
            --paper-input-container-label: {
                font-size: 24px;
            };
            --paper-input-container-input: {
                margin-top: 1rem;
            }
        }

        input[required] {
            font-weight: 500;
        }

        label.ts-questionnaire {
            margin-top: 1.5rem;
            padding-top: 0.5rem;
            display: block;
            color: #707070;
            letter-spacing: 0.011em;
        }

        label.ts-questionnaire.error {
            color: red;
        }

        paper-radio-group {
            display: block;
            margin-top: 0.1rem;
        }

        paper-radio-button:first-child {
            padding-left: 0;
        }

        .radio-error-message {
            display: none;
            color: red;
        }

        .error .radio-error-message {
            display: inline;
        }



    </style>

    <template>

        <div class="questions">
            <neon-animated-pages selected="{{step}}">

                <template is="dom-repeat" items="[[questions]]" as="group">
                    <div selected="{{step}}" class="question-group">

                        <template is="dom-repeat" items="[[group]]" as="question">
                            
                            <template is="dom-if" if="{{_isStringInput(question.input_type)}}">
                                <paper-input name="{{question.id}}" label="{{question.sort}}. {{question.text}}" always-float-label placeholder="{{question.help}}" required="{{question.required}}" error-message="Required" class="{{_isRequiredClass(question.required)}}"></paper-input>
                            </template>

                            <template is="dom-if" if="{{_isBooleanInput(question.input_type)}}">
                                <label>{{question.sort}}. {{question.text}}</label>
                                <paper-radio-group selected="" name="{{question.id}}" attr-for-selected="value" data-required="{{question.required}}">
                                    <paper-radio-button name="{{question.id}}" value="yes">Yes</paper-radio-button>
                                    <paper-radio-button name="{{question.id}}" value="no">No</paper-radio-button>
                                    <p class="radio-error-message">Required</p>
                                </paper-radio-group>
                            </template>

                        </template>

                    </div>
                </template>

            </neon-animated-pages>
        </div>

        <div class="actions">
            <paper-button class="btn btn-previous" on-tap="previous">
                <iron-icon class="icn icn-prev" icon="icons:chevron-left"></iron-icon>
            </paper-button>
            <paper-button class="btn btn-cancel" on-tap="cancel">Cancel</paper-button>
            <paper-button class="btn btn-next" on-tap="next">
                <iron-icon class="icn icn-next" icon="icons:chevron-right"></iron-icon>
            </paper-button>
        </div>

    </template>

</dom-module>


<script>

    Polymer({

        is: 'ts-questionnaire',

        behaviors: [
            Polymer.IronResizableBehavior,
            Polymer.NeonAnimatableBehavior,
            Polymer.IronValidatableBehavior
        ],

        properties: {
            selected: {
                type: Number,
                value: 0,
                notify: true
            },
            newdata: {
                type: Object,
                value: {},
                notify: true
            },
            importdata: {
                type: Object,
                value: {},
                notify: true
            },
            questions: {
                type: Array,
                value: []
            },
            step: {
                type: Number,
                value: 0
            },
            hasError: {
                type: Boolean,
                value: false
            }
        },

        ready: function() {
            this.questions = App.questionnaire.questions;
        },

        cancel: function () {
            this.set('selected', 0);
        },

        next: function() {
            (this.checkAnswers() && (this.step < this.questions.length - 1)) && this.step++;
        },

        previous: function() {
            (this.step > 0) && this.step--;
        },

        checkAnswers: function() {
            var currentGroup = document.querySelector('.question-group.iron-selected'),
                questions = Array.prototype.slice.call(currentGroup.querySelectorAll('paper-input, paper-radio-group')),
                _this = this;
            
            return questions.every(function(q) {
                var pass = (q.validate && q.validate())
                    || (q.nodeName === 'PAPER-RADIO-GROUP' && (!q.dataRequired || q.dataRequired && q.selected))
                    || false;
                pass ? _this._hideError(q) : _this._showError(q);
                return pass;
            });
        },

        _showError: function(q) {
            q.classList.add('error');
            if (q.nodeName === 'PAPER-RADIO-GROUP') {
                q.previousElementSibling.classList.add('error');
            }
        },

        _hideError: function(q) {
            q.classList.remove('error');
            if (q.nodeName === 'PAPER-RADIO-GROUP') {
                q.previousElementSibling.classList.remove('error');
            }
        },

        _isStringInput: function(inputType) {
            return inputType === 'string';
        },

        _isBooleanInput: function(inputType) {
            return inputType === 'boolean';
        },

        _isRequiredClass: function(required) {
            return required ? 'required' : '';
        }


    });

</script>